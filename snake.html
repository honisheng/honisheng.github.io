<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>觸控版貪吃蛇</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --accent:#22d3ee; --text:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; background:var(--bg); color:var(--text); text-align:center}
    h2{margin:12px 0}
    #scoreBar{margin:6px 0 0 0; font-weight:600}
    canvas{display:block; margin:10px auto; background:#0b1020; border:3px solid var(--accent); border-radius:10px; touch-action:none}
    /* 全螢幕開始畫面 */
    #startScreen{
      position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 50% -20%, #1f2937 0%, #0b1020 40%, #050814 100%);
      gap:16px; z-index:10; padding:20px;
    }
    #title{font-size:clamp(28px,5vw,44px); letter-spacing:1px}
    #startBtn{
      padding:14px 28px; border:none; border-radius:12px; font-size:18px; cursor:pointer; background:var(--accent); color:#06121d; font-weight:700;
      box-shadow:0 10px 30px rgba(34,211,238,.35);
    }
    #leaderboard{
      width:min(480px,90vw); background:rgba(17,24,39,.6); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:12px 16px; text-align:left; backdrop-filter: blur(6px);
    }
    #leaderboard h3{margin:4px 0 8px 0; text-align:center}
    #scoreList{margin:0; padding:0 16px}
    #hint{opacity:.8; font-size:14px}
  </style>
</head>
<body>
  <!-- 開始畫面 -->
  <div id="startScreen">
    <div id="title">🐍 觸控版貪吃蛇</div>
    <button id="startBtn">開始遊戲</button>
    <div id="leaderboard">
      <h3>🏆 排行榜（前 10 名）</h3>
      <ol id="scoreList"></ol>
      <div id="hint">提示：按方向鍵或在遊戲區域<strong>滑動</strong>即可開始移動</div>
    </div>
  </div>

  <!-- 遊戲區 -->
  <h2>遊戲中</h2>
  <div id="scoreBar">分數：<span id="score">0</span></div>
  <canvas id="game" width="400" height="400"></canvas>

  <!-- Firebase（Firestore compat） -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    // TODO: 換成你的 Firebase 專案設定
    const firebaseConfig = {
      apiKey: "AIzaSyCRKeXJg7ZFyoy2N3RoVgMFnaaHQ1y5WWE",
    authDomain: "wedding-3e426.firebaseapp.com",
    projectId: "wedding-3e426",
    storageBucket: "wedding-3e426.firebasestorage.app",
    messagingSenderId: "531046039955",
    appId: "1:531046039955:web:ac629474956529c160e866"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // －－ 遊戲常數 －－
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const CELL = 20;                 // 單格像素
    const COLS = canvas.width / CELL;
    const ROWS = canvas.height / CELL;
    const TICK_MS = 150;

    // －－ 遊戲狀態 －－
    let snake, dir, food, score, loopId, running;

    function randInt(n){ return Math.floor(Math.random()*n); }
    function drawCell(x,y,fill){
      ctx.fillStyle = fill;
      // 讓格子有 1px 間隙，看起來更清楚
      ctx.fillRect(x*CELL+1, y*CELL+1, CELL-2, CELL-2);
    }
    function spawnFood(){
      // 避免食物生成在蛇身上
      let p;
      do { p = {x:randInt(COLS), y:randInt(ROWS)}; }
      while (snake.some(s => s.x===p.x && s.y===p.y));
      return p;
    }
    function resetGame(){
      snake = [{x: Math.floor(COLS/2), y: Math.floor(ROWS/2)}];
      dir = {x:0,y:0};                 // 待機：尚未選方向
      food = spawnFood();
      score = 0;
      running = false;                 // 尚未開始迴圈
      document.getElementById('score').textContent = score;
      stopLoop();
      drawBoard();
    }
    function drawBoard(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // 食物
      drawCell(food.x, food.y, '#ef4444');
      // 蛇
      snake.forEach((s,i)=>drawCell(s.x,s.y, i===0 ? '#34d399' : '#10b981'));
    }

    function startLoop(){
      if (loopId) return;
      loopId = setInterval(tick, TICK_MS);
    }
    function stopLoop(){
      if (loopId){ clearInterval(loopId); loopId = null; }
    }

    function tick(){
      if (!running) return;           // 還沒選方向就不跑邏輯（只保持畫面）
      const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

      // 撞牆
      if (head.x<0 || head.y<0 || head.x>=COLS || head.y>=ROWS){
        return gameOver();
      }
      // 撞自己：只檢查身體（排除原本的頭）
      if (snake.slice(1).some(s => s.x===head.x && s.y===head.y)){
        return gameOver();
      }

      // 前進
      snake.unshift(head);

      // 吃到食物
      if (head.x===food.x && head.y===food.y){
        score++;
        document.getElementById('score').textContent = score;
        food = spawnFood();
      }else{
        snake.pop();
      }

      drawBoard();
    }

    // －－ 輸入控制 －－
    function setDirection(nx, ny){
      // 禁止直接 180 度反向
      if (snake.length>1 && nx === -dir.x && ny === -dir.y) return;
      dir = {x:nx, y:ny};
      if (!running){
        running = true;   // 第一次選方向 → 才開始運動
        startLoop();      // 啟動迴圈（若尚未啟動）
      }
    }

    // 鍵盤
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowUp'    && dir.y !== 1)  setDirection(0,-1);
      else if (e.key === 'ArrowDown' && dir.y !== -1) setDirection(0,1);
      else if (e.key === 'ArrowLeft' && dir.x !== 1)  setDirection(-1,0);
      else if (e.key === 'ArrowRight'&& dir.x !== -1) setDirection(1,0);
    });

    // 觸控滑動
    let sx=0, sy=0;
    canvas.addEventListener('touchstart', (e)=>{
      const t = e.touches[0]; sx=t.clientX; sy=t.clientY;
    }, {passive:true});
    canvas.addEventListener('touchend', (e)=>{
      const t = e.changedTouches[0];
      const dx = t.clientX - sx, dy = t.clientY - sy;
      if (Math.abs(dx) > Math.abs(dy)){
        if (dx>0 && dir.x!==-1) setDirection(1,0);
        else if (dx<0 && dir.x!==1) setDirection(-1,0);
      }else{
        if (dy>0 && dir.y!==-1) setDirection(0,1);
        else if (dy<0 && dir.y!==1) setDirection(0,-1);
      }
    }, {passive:true});

    // －－ UI：開始 / 結束 / 排行榜 －－
    const startScreen = document.getElementById('startScreen');
    const startBtn = document.getElementById('startBtn');
    const scoreList = document.getElementById('scoreList');

    startBtn.addEventListener('click', ()=>{
      startScreen.style.display = 'none';
      resetGame();       // 進入待機畫面（蛇靜止）
      drawBoard();
      // 不啟動迴圈，直到玩家第一次滑動/按鍵才 startLoop()
    });

    function gameOver(){
      stopLoop();
      running = false;
      // 取名並上傳
      const name = prompt(`遊戲結束！\n你的分數：${score}\n請輸入玩家名稱：`, '玩家');
      if (name && name.trim()){
        db.collection('scores').add({
          name: name.trim(),
          score: score,
          time: firebase.firestore.FieldValue.serverTimestamp()
        }).then(loadLeaderboard);
      }
      // 回到開始畫面
      startScreen.style.display = 'flex';
    }

    function loadLeaderboard(){
      scoreList.innerHTML = '<li>載入中…</li>';
      db.collection('scores').orderBy('score','desc').limit(10).get()
        .then(snap=>{
          scoreList.innerHTML = '';
          let rank = 1;
          snap.forEach(doc=>{
            const d = doc.data();
            const li = document.createElement('li');
            li.textContent = `#${rank++} ${d.name || '匿名'} — ${d.score} 分`;
            scoreList.appendChild(li);
          });
          if (rank===1){ scoreList.innerHTML = '<li>目前沒有分數，成為第一個上榜的人吧！</li>'; }
        })
        .catch(()=>{
          scoreList.innerHTML = '<li>排行榜讀取失敗</li>';
        });
    }

    // 初始：顯示排行榜與靜止畫面
    loadLeaderboard();
    resetGame();
    drawBoard();
  </script>
</body>
</html>
