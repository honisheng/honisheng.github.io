<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è§¸æ§ç‰ˆè²ªåƒè›‡</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --accent:#22d3ee; --text:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; background:var(--bg); color:var(--text); text-align:center}
    h2{margin:12px 0}
    #scoreBar{margin:6px 0 0 0; font-weight:600}
    canvas{display:block; margin:10px auto; background:#0b1020; border:3px solid var(--accent); border-radius:10px; touch-action:none}
    /* å…¨è¢å¹•é–‹å§‹ç•«é¢ */
    #startScreen{
      position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 50% -20%, #1f2937 0%, #0b1020 40%, #050814 100%);
      gap:16px; z-index:10; padding:20px;
    }
    #title{font-size:clamp(28px,5vw,44px); letter-spacing:1px}
    #startBtn{
      padding:14px 28px; border:none; border-radius:12px; font-size:18px; cursor:pointer; background:var(--accent); color:#06121d; font-weight:700;
      box-shadow:0 10px 30px rgba(34,211,238,.35);
    }
    #leaderboard{
      width:min(480px,90vw); background:rgba(17,24,39,.6); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:12px 16px; text-align:left; backdrop-filter: blur(6px);
    }
    #leaderboard h3{margin:4px 0 8px 0; text-align:center}
    #scoreList{margin:0; padding:0 16px}
    #hint{opacity:.8; font-size:14px}
  </style>
</head>
<body>
  <!-- é–‹å§‹ç•«é¢ -->
  <div id="startScreen">
    <div id="title">ğŸ è§¸æ§ç‰ˆè²ªåƒè›‡</div>
    <button id="startBtn">é–‹å§‹éŠæˆ²</button>
    <div id="leaderboard">
      <h3>ğŸ† æ’è¡Œæ¦œï¼ˆå‰ 10 åï¼‰</h3>
      <ol id="scoreList"></ol>
      <div id="hint">æç¤ºï¼šæŒ‰æ–¹å‘éµæˆ–åœ¨éŠæˆ²å€åŸŸ<strong>æ»‘å‹•</strong>å³å¯é–‹å§‹ç§»å‹•</div>
    </div>
  </div>

  <!-- éŠæˆ²å€ -->
  <h2>éŠæˆ²ä¸­</h2>
  <div id="scoreBar">åˆ†æ•¸ï¼š<span id="score">0</span></div>
  <canvas id="game" width="400" height="400"></canvas>

  <!-- Firebaseï¼ˆFirestore compatï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    // TODO: æ›æˆä½ çš„ Firebase å°ˆæ¡ˆè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCRKeXJg7ZFyoy2N3RoVgMFnaaHQ1y5WWE",
    authDomain: "wedding-3e426.firebaseapp.com",
    projectId: "wedding-3e426",
    storageBucket: "wedding-3e426.firebasestorage.app",
    messagingSenderId: "531046039955",
    appId: "1:531046039955:web:ac629474956529c160e866"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ï¼ï¼ éŠæˆ²å¸¸æ•¸ ï¼ï¼
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const CELL = 20;                 // å–®æ ¼åƒç´ 
    const COLS = canvas.width / CELL;
    const ROWS = canvas.height / CELL;
    const TICK_MS = 150;

    // ï¼ï¼ éŠæˆ²ç‹€æ…‹ ï¼ï¼
    let snake, dir, food, score, loopId, running;

    function randInt(n){ return Math.floor(Math.random()*n); }
    function drawCell(x,y,fill){
      ctx.fillStyle = fill;
      // è®“æ ¼å­æœ‰ 1px é–“éš™ï¼Œçœ‹èµ·ä¾†æ›´æ¸…æ¥š
      ctx.fillRect(x*CELL+1, y*CELL+1, CELL-2, CELL-2);
    }
    function spawnFood(){
      // é¿å…é£Ÿç‰©ç”Ÿæˆåœ¨è›‡èº«ä¸Š
      let p;
      do { p = {x:randInt(COLS), y:randInt(ROWS)}; }
      while (snake.some(s => s.x===p.x && s.y===p.y));
      return p;
    }
    function resetGame(){
      snake = [{x: Math.floor(COLS/2), y: Math.floor(ROWS/2)}];
      dir = {x:0,y:0};                 // å¾…æ©Ÿï¼šå°šæœªé¸æ–¹å‘
      food = spawnFood();
      score = 0;
      running = false;                 // å°šæœªé–‹å§‹è¿´åœˆ
      document.getElementById('score').textContent = score;
      stopLoop();
      drawBoard();
    }
    function drawBoard(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // é£Ÿç‰©
      drawCell(food.x, food.y, '#ef4444');
      // è›‡
      snake.forEach((s,i)=>drawCell(s.x,s.y, i===0 ? '#34d399' : '#10b981'));
    }

    function startLoop(){
      if (loopId) return;
      loopId = setInterval(tick, TICK_MS);
    }
    function stopLoop(){
      if (loopId){ clearInterval(loopId); loopId = null; }
    }

    function tick(){
      if (!running) return;           // é‚„æ²’é¸æ–¹å‘å°±ä¸è·‘é‚è¼¯ï¼ˆåªä¿æŒç•«é¢ï¼‰
      const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

      // æ’ç‰†
      if (head.x<0 || head.y<0 || head.x>=COLS || head.y>=ROWS){
        return gameOver();
      }
      // æ’è‡ªå·±ï¼šåªæª¢æŸ¥èº«é«”ï¼ˆæ’é™¤åŸæœ¬çš„é ­ï¼‰
      if (snake.slice(1).some(s => s.x===head.x && s.y===head.y)){
        return gameOver();
      }

      // å‰é€²
      snake.unshift(head);

      // åƒåˆ°é£Ÿç‰©
      if (head.x===food.x && head.y===food.y){
        score++;
        document.getElementById('score').textContent = score;
        food = spawnFood();
      }else{
        snake.pop();
      }

      drawBoard();
    }

    // ï¼ï¼ è¼¸å…¥æ§åˆ¶ ï¼ï¼
    function setDirection(nx, ny){
      // ç¦æ­¢ç›´æ¥ 180 åº¦åå‘
      if (snake.length>1 && nx === -dir.x && ny === -dir.y) return;
      dir = {x:nx, y:ny};
      if (!running){
        running = true;   // ç¬¬ä¸€æ¬¡é¸æ–¹å‘ â†’ æ‰é–‹å§‹é‹å‹•
        startLoop();      // å•Ÿå‹•è¿´åœˆï¼ˆè‹¥å°šæœªå•Ÿå‹•ï¼‰
      }
    }

    // éµç›¤
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowUp'    && dir.y !== 1)  setDirection(0,-1);
      else if (e.key === 'ArrowDown' && dir.y !== -1) setDirection(0,1);
      else if (e.key === 'ArrowLeft' && dir.x !== 1)  setDirection(-1,0);
      else if (e.key === 'ArrowRight'&& dir.x !== -1) setDirection(1,0);
    });

    // è§¸æ§æ»‘å‹•
    let sx=0, sy=0;
    canvas.addEventListener('touchstart', (e)=>{
      const t = e.touches[0]; sx=t.clientX; sy=t.clientY;
    }, {passive:true});
    canvas.addEventListener('touchend', (e)=>{
      const t = e.changedTouches[0];
      const dx = t.clientX - sx, dy = t.clientY - sy;
      if (Math.abs(dx) > Math.abs(dy)){
        if (dx>0 && dir.x!==-1) setDirection(1,0);
        else if (dx<0 && dir.x!==1) setDirection(-1,0);
      }else{
        if (dy>0 && dir.y!==-1) setDirection(0,1);
        else if (dy<0 && dir.y!==1) setDirection(0,-1);
      }
    }, {passive:true});

    // ï¼ï¼ UIï¼šé–‹å§‹ / çµæŸ / æ’è¡Œæ¦œ ï¼ï¼
    const startScreen = document.getElementById('startScreen');
    const startBtn = document.getElementById('startBtn');
    const scoreList = document.getElementById('scoreList');

    startBtn.addEventListener('click', ()=>{
      startScreen.style.display = 'none';
      resetGame();       // é€²å…¥å¾…æ©Ÿç•«é¢ï¼ˆè›‡éœæ­¢ï¼‰
      drawBoard();
      // ä¸å•Ÿå‹•è¿´åœˆï¼Œç›´åˆ°ç©å®¶ç¬¬ä¸€æ¬¡æ»‘å‹•/æŒ‰éµæ‰ startLoop()
    });

    function gameOver(){
      stopLoop();
      running = false;
      // å–åä¸¦ä¸Šå‚³
      const name = prompt(`éŠæˆ²çµæŸï¼\nä½ çš„åˆ†æ•¸ï¼š${score}\nè«‹è¼¸å…¥ç©å®¶åç¨±ï¼š`, 'ç©å®¶');
      if (name && name.trim()){
        db.collection('scores').add({
          name: name.trim(),
          score: score,
          time: firebase.firestore.FieldValue.serverTimestamp()
        }).then(loadLeaderboard);
      }
      // å›åˆ°é–‹å§‹ç•«é¢
      startScreen.style.display = 'flex';
    }

    function loadLeaderboard(){
      scoreList.innerHTML = '<li>è¼‰å…¥ä¸­â€¦</li>';
      db.collection('scores').orderBy('score','desc').limit(10).get()
        .then(snap=>{
          scoreList.innerHTML = '';
          let rank = 1;
          snap.forEach(doc=>{
            const d = doc.data();
            const li = document.createElement('li');
            li.textContent = `#${rank++} ${d.name || 'åŒ¿å'} â€” ${d.score} åˆ†`;
            scoreList.appendChild(li);
          });
          if (rank===1){ scoreList.innerHTML = '<li>ç›®å‰æ²’æœ‰åˆ†æ•¸ï¼Œæˆç‚ºç¬¬ä¸€å€‹ä¸Šæ¦œçš„äººå§ï¼</li>'; }
        })
        .catch(()=>{
          scoreList.innerHTML = '<li>æ’è¡Œæ¦œè®€å–å¤±æ•—</li>';
        });
    }

    // åˆå§‹ï¼šé¡¯ç¤ºæ’è¡Œæ¦œèˆ‡éœæ­¢ç•«é¢
    loadLeaderboard();
    resetGame();
    drawBoard();
  </script>
</body>
</html>
